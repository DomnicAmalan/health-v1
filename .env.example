# ============================================
# Health V1 - Environment Configuration Template
# ============================================
# INSTRUCTIONS FOR NEW DEVELOPERS:
# 1. Copy this file to .env:
#    cp .env.example .env
#
# 2. Update the values below with your configuration
#    (these are safe defaults for development)
#
# 3. IMPORTANT: Change all security secrets before deploying to production!
#    - JWT_SECRET
#    - MASTER_KEY
#    - POSTGRES_PASSWORD
#    - VAULT_TOKEN
#
# For app-specific Vite configuration, also copy:
#   - cli/packages/apps/admin/.env.example → .env
#   - cli/packages/apps/client-app/.env.example → .env
#   - cli/packages/apps/rustyvault-ui/.env.example → .env
#
# Documentation: See ENV.md for comprehensive guide
# ============================================

# ============================================
# Core Service Ports
# ============================================
# Main API Service (backend)
API_SERVICE_PORT=8080          # External port for API service
SERVER_PORT=8080               # Internal port backend listens on (inside Docker)
SERVER_HOST=0.0.0.0            # Bind to all interfaces

# RustyVault Service (secrets management)
VAULT_SERVICE_PORT=4117        # External port for Vault service
VAULT_SERVER_PORT=4117         # Internal port Vault listens on (inside Docker)
VAULT_SERVER_HOST=0.0.0.0      # Bind to all interfaces
VAULT_ADDR=http://localhost:4117  # Vault client address
VAULT_TOKEN=dev-root-token     # Development token (CHANGE IN PRODUCTION!)

# PostgreSQL Database
POSTGRES_PORT=5432             # Database port

# ============================================
# Frontend Dev Server Ports (Vite)
# ============================================
ADMIN_UI_PORT=5174             # Admin dashboard Vite dev server
CLIENT_APP_PORT=5175           # Client application Vite dev server
VAULT_UI_PORT=8215             # RustyVault UI Vite dev server (NOTE: 8215, not 5176!)

# ============================================
# API URLs (for frontend consumption)
# ============================================
# Main API Service - used by admin and client-app
API_BASE_URL=http://localhost:8080
ADMIN_UI_API_BASE_URL=http://localhost:8080
CLIENT_APP_API_BASE_URL=http://localhost:8080

# Vault Service - used by rustyvault-ui (different service!)
VAULT_API_BASE_URL=http://localhost:4117/v1
VAULT_UI_API_BASE_URL=http://localhost:4117/v1

# ============================================
# CORS Configuration
# ============================================
# CRITICAL: Include ALL frontend dev server origins to prevent CORS errors
# This single variable controls all CORS for the backend
CORS_ALLOWED_ORIGINS=http://localhost:5174,http://localhost:5175,http://localhost:8215,http://localhost:5173

# App-specific CORS origins (legacy - prefer CORS_ALLOWED_ORIGINS)
CORS_ADMIN_UI_ORIGINS=http://localhost:5174
CORS_CLIENT_UI_ORIGINS=http://localhost:5175
CORS_VAULT_UI_ORIGINS=http://localhost:8215
VAULT_CORS_ORIGINS=*           # RustyVault CORS (use * for dev only)

# ============================================
# Database Configuration
# ============================================
POSTGRES_USER=auth_user
POSTGRES_PASSWORD=auth_password
POSTGRES_DB=auth_db

# Connection pool limits (optimized for 512MB RAM systems)
DATABASE_MAX_CONNECTIONS=5
DATABASE_MIN_CONNECTIONS=1

# ============================================
# Auth & Security Configuration
# ============================================
# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-in-production-min-32-chars
JWT_EXPIRATION=3600            # Token expiration in seconds (1 hour)

# OIDC Configuration
OIDC_ISSUER=http://localhost:8080
OIDC_CLIENT_ID=default-client
OIDC_CLIENT_SECRET=default-secret

# Vite OIDC Configuration (for frontend builds)
VITE_OIDC_ISSUER=http://localhost:8080
VITE_OIDC_CLIENT_ID=default-client
# Note: VITE_OIDC_REDIRECT_URI is app-specific (set in app .env files)

# ============================================
# Session Configuration
# ============================================
# App-specific session TTLs (in hours)
SESSION_ADMIN_UI_TTL_HOURS=8   # Admin sessions last 8 hours
SESSION_CLIENT_UI_TTL_HOURS=24 # Client sessions last 24 hours
SESSION_API_TTL_HOURS=1        # API sessions last 1 hour

# Session cache size limit (for 512MB RAM systems)
SESSION_CACHE_MAX_ENTRIES=1000

# ============================================
# Encryption & Key Management
# ============================================
# KMS Provider (using RustyVault for secrets management)
KMS_PROVIDER=rustyvault

# Development master key (32 bytes hex-encoded)
# CRITICAL: DO NOT USE THIS IN PRODUCTION!
# Generate a new key: openssl rand -hex 32
MASTER_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

# ============================================
# Storage Configuration
# ============================================
# Storage provider options: local, encrypted_local, s3
STORAGE_PROVIDER=encrypted_local
LOCAL_STORAGE_PATH=./storage
STORAGE_ENCRYPTION_ENABLED=true

# Realm/Service DEK Isolation
ENABLE_REALM_DEK_ISOLATION=true
ENABLE_SERVICE_DEK_ISOLATION=true

# ============================================
# RustyVault Configuration
# ============================================
VAULT_MOUNT_PATH=secret
VAULT_STORAGE_BACKEND=file
VAULT_STORAGE_PATH=/app/vault-data
VAULT_BARRIER_ALGORITHM=aes-gcm
VAULT_BARRIER_KEY_LENGTH=32
VAULT_SECRET_SHARES=5          # Shamir secret shares
VAULT_SECRET_THRESHOLD=3       # Minimum shares needed to unseal

# Zanzibar-Vault Integration
ENABLE_ZANZIBAR_VAULT_SYNC=true
ZANZIBAR_VAULT_SYNC_INTERVAL=60

# ============================================
# Logging & Monitoring
# ============================================
LOG_LEVEL=info
RUST_LOG=info

# ============================================
# Deployment Configuration
# ============================================
DEPLOYMENT_ENV=development
CLOUD_PROVIDER=none

# ============================================
# Resource Limits (512MB RAM optimization)
# ============================================
# Graph cache configuration
GRAPH_CACHE_ENABLED=true
GRAPH_CACHE_TTL_SECONDS=60

# Tokio runtime configuration (limit worker threads)
TOKIO_WORKER_THREADS=2

# Rust build configuration (for low-memory systems)
CARGO_BUILD_JOBS=2

# ============================================
# Service Enable Flags
# ============================================
# Core services (always enabled in dev)
ENABLE_POSTGRES=true
ENABLE_RUSTYVAULT=true
ENABLE_RUSTYVAULT_SERVICE=true

# Optional services (disabled by default)
ENABLE_NATS=false
ENABLE_KAFKA=false
ENABLE_SONARQUBE=false

# Vite build-time flags (for frontend feature toggles)
VITE_ENABLE_POSTGRES=true
VITE_ENABLE_NATS=false
VITE_ENABLE_KAFKA=false

# ============================================
# NATS Configuration (optional - disabled by default)
# ============================================
NATS_URL=nats://localhost:4225
NATS_PORT=4225
NATS_HTTP_PORT=8225
NATS_CLUSTER_PORT=6225
NATS_ENABLE_JETSTREAM=true

# ============================================
# Kafka Configuration (optional - disabled by default)
# ============================================
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
KAFKA_PORT=9092
KAFKA_INTERNAL_PORT=29092
KAFKA_CONTROLLER_PORT=29093
KAFKA_UI_PORT=8081

# KRaft mode configuration (no Zookeeper)
KAFKA_PROCESS_ROLES=broker,controller
KAFKA_NODE_ID=1
KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:29093

# ============================================
# SonarQube Configuration (optional - disabled by default)
# ============================================
SONARQUBE_PORT=9000
SONARQUBE_VERSION=community
SONARQUBE_DB=sonar

# SonarQube Database (separate PostgreSQL instance)
SONARQUBE_DB_USER=sonar
SONARQUBE_DB_PASSWORD=sonar_password
SONARQUBE_DB_PORT=5444

# SonarQube Server
SONAR_HOST_URL=http://localhost:9000
SONAR_TOKEN=
SONAR_ORGANIZATION=

# SonarQube Java options (optimized for 512MB RAM systems)
SONAR_CE_JAVAOPTS="-Xmx512m -Xms128m"
SONAR_WEB_JAVAOPTS="-Xmx512m -Xms128m"
SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
